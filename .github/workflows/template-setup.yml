name: Template Repository Setup

on:
  push:
    branches:
      - main
      - master
  repository_dispatch:
    types: [repository-created]
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  actions: write

jobs:
  setup:
    name: Setup New Repository from Template
    runs-on: ubuntu-latest
    # Only run on first push (initial commit) or manual trigger
    # Check if this is the initial commit by checking if before SHA is all zeros
    if: |
      github.event_name == 'workflow_dispatch' || 
      github.event_name == 'repository_dispatch' || 
      github.event.before == '0000000000000000000000000000000000000000'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if this is initial commit
        id: check-initial
        run: |
          COMMIT_COUNT=$(git rev-list --count HEAD 2>/dev/null || echo "1")
          if [ "$COMMIT_COUNT" -le "1" ]; then
            echo "is_initial=true" >> $GITHUB_OUTPUT
            echo "âœ… This appears to be the initial commit (commit count: $COMMIT_COUNT)"
          else
            echo "is_initial=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  Not the initial commit (commit count: $COMMIT_COUNT), skipping setup"
          fi

      - name: Create Production Environment
        if: steps.check-initial.outputs.is_initial == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              await github.rest.repos.getEnvironment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                environment_name: 'production'
              });
              console.log('âœ… Production environment already exists');
            } catch (error) {
              if (error.status === 404) {
                await github.rest.repos.createOrUpdateEnvironment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  environment_name: 'production'
                });
                console.log('âœ… Created production environment');
              } else {
                throw error;
              }
            }

      - name: Install GitHub CLI
        if: steps.check-initial.outputs.is_initial == 'true'
        run: |
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y

      - name: Generate TERRAFORM_STATE_PASSWORD
        if: steps.check-initial.outputs.is_initial == 'true'
        id: generate-password
        run: |
          PASSWORD=$(openssl rand -base64 32)
          echo "password=$PASSWORD" >> $GITHUB_OUTPUT
          echo "âœ… Generated TERRAFORM_STATE_PASSWORD"

      - name: Set TERRAFORM_STATE_PASSWORD Secret
        if: steps.check-initial.outputs.is_initial == 'true'
        id: set-password
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          if [ -n "$GH_PAT" ]; then
            echo "${{ steps.generate-password.outputs.password }}" | gh secret set TERRAFORM_STATE_PASSWORD --env production --repo "${{ github.repository }}"
            echo "âœ… Set TERRAFORM_STATE_PASSWORD secret"
          else
            echo "âš ï¸  GH_PAT not provided, skipping auto-set of TERRAFORM_STATE_PASSWORD"
            echo "skipped=true" >> $GITHUB_OUTPUT
          fi

      - name: Trigger Setup Workflow
        if: steps.check-initial.outputs.is_initial == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'setup.yml',
              ref: context.ref,
              inputs: {
                setup_mode: 'auto-setup'
              }
            });

      - name: Create Welcome Issue
        if: steps.check-initial.outputs.is_initial == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const passwordValue = '${{ steps.generate-password.outputs.password }}';
            const setPasswordSkipped = '${{ steps.set-password.outputs.skipped }}' === 'true';
            const passwordSet = !setPasswordSkipped && '${{ steps.set-password.outcome }}' === 'success';
            const passwordDisplay = passwordSet ? 'âœ… (auto-set)' : `\`${passwordValue}\` (copy this value)`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš€ Welcome! Repository Setup Required',
              body: '# Welcome to Your New Repository!\n\n' +
                'This repository was created from a template. Follow these steps to get started:\n\n' +
                '## âœ… Auto-Setup Complete\n\n' +
                '- âœ… Production environment created\n' +
                `- âœ… TERRAFORM_STATE_PASSWORD: ${passwordDisplay}\n\n` +
                '## ðŸ”§ Next Steps\n\n' +
                '1. **Configure GitHub Secrets**\n' +
                '   - Go to **Settings** â†’ **Environments** â†’ **production** â†’ **Add secret**\n' +
                '   - Add the following required secrets:\n\n' +
                '### Required Secrets\n\n' +
                '- `CLOUDFLARE_API_TOKEN` - Your Cloudflare API token\n' +
                '- `VERCEL_API_TOKEN` - Your Vercel API token\n' +
                '- `SUPABASE_URL` - Your Supabase project URL\n' +
                '- `SUPABASE_ANON_KEY` - Supabase anonymous key\n' +
                '- `SUPABASE_SERVICE_ROLE_KEY` - Supabase service role key\n' +
                '- `SUPABASE_ACCESS_TOKEN` - Supabase access token\n' +
                '- `SUPABASE_PROJECT_ID` - Supabase project ID\n' +
                '- `DOMAIN_NAME` - Your domain name\n' +
                (passwordSet ? '' : `- \`TERRAFORM_STATE_PASSWORD\` - Use: \`${passwordValue}\`\n`) +
                '\n2. **Validate Secrets**\n' +
                '   - Go to **Actions** â†’ **Repository Setup** â†’ **Run workflow**\n' +
                '   - Select `validate` mode to check your secrets\n\n' +
                '3. **Deploy Infrastructure**\n' +
                '   - Once secrets are validated, run **Terraform Infrastructure** workflow\n' +
                '   - Start with `plan` command to preview changes\n\n' +
                '## ðŸ“š Documentation\n\n' +
                'For detailed instructions, see [.github/TERRAFORM_SETUP.md](.github/TERRAFORM_SETUP.md)'
            });

