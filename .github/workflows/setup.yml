name: Repository Setup

on:
  repository_dispatch:
    types: [setup-secrets]
  workflow_dispatch:
    inputs:
      setup_mode:
        description: 'Setup mode'
        required: true
        type: choice
        options:
          - validate
          - create-template
          - auto-setup
        default: validate

jobs:
  setup:
    name: Setup Secrets Validation
    runs-on: ubuntu-latest
    if: github.event.inputs.setup_mode == 'validate' || github.event.client_payload.setup_mode == 'validate'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Required Secrets
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          VERCEL_API_TOKEN: ${{ secrets.VERCEL_API_TOKEN }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DATABASE_PASSWORD: ${{ secrets.SUPABASE_DATABASE_PASSWORD }}
          DOMAIN_NAME: ${{ secrets.DOMAIN_NAME }}
          TERRAFORM_STATE_PASSWORD: ${{ secrets.TERRAFORM_STATE_PASSWORD }}
        run: |
          echo "## ðŸ” Validating Secrets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          missing_secrets=()
          invalid_secrets=()
          warnings=()
          
          # Extract project ID from SUPABASE_URL if provided
          if [ -n "$SUPABASE_URL" ]; then
            # Extract project ID from URL: https://xxxxx.supabase.co -> xxxxx
            EXTRACTED_PROJECT_ID=$(echo "$SUPABASE_URL" | sed -E 's|https?://([^.]+)\.supabase\.co.*|\1|')
            if [ -n "$EXTRACTED_PROJECT_ID" ] && [ "$EXTRACTED_PROJECT_ID" != "$SUPABASE_URL" ]; then
              echo "â„¹ï¸  Project ID extracted from SUPABASE_URL: \`$EXTRACTED_PROJECT_ID\`" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          # Check if secrets are set
          if [ -z "$CLOUDFLARE_API_TOKEN" ]; then 
            missing_secrets+=("CLOUDFLARE_API_TOKEN")
          elif [ ${#CLOUDFLARE_API_TOKEN} -ne 40 ] || ! echo "$CLOUDFLARE_API_TOKEN" | grep -qE '^[a-zA-Z0-9_-]+$'; then
            invalid_secrets+=("CLOUDFLARE_API_TOKEN (must be exactly 40 characters, alphanumeric, hyphens, underscores only)")
          fi
          
          if [ -z "$VERCEL_API_TOKEN" ]; then missing_secrets+=("VERCEL_API_TOKEN"); fi
          if [ -z "$SUPABASE_URL" ]; then 
            missing_secrets+=("SUPABASE_URL")
          elif ! echo "$SUPABASE_URL" | grep -qE '^https?://[^.]+\.supabase\.co'; then
            invalid_secrets+=("SUPABASE_URL (must be in format: https://xxxxx.supabase.co)")
          fi
          if [ -z "$SUPABASE_ANON_KEY" ]; then missing_secrets+=("SUPABASE_ANON_KEY"); fi
          if [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then missing_secrets+=("SUPABASE_SERVICE_ROLE_KEY"); fi
          if [ -z "$SUPABASE_DATABASE_PASSWORD" ]; then missing_secrets+=("SUPABASE_DATABASE_PASSWORD"); fi
          if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then missing_secrets+=("SUPABASE_ACCESS_TOKEN"); fi
          if [ -z "$DOMAIN_NAME" ]; then missing_secrets+=("DOMAIN_NAME"); fi
          if [ -z "$TERRAFORM_STATE_PASSWORD" ]; then missing_secrets+=("TERRAFORM_STATE_PASSWORD"); fi
          
          # Report invalid secrets
          if [ ${#invalid_secrets[@]} -gt 0 ]; then
            echo "::error title=Invalid Secret Format::One or more secrets have invalid format" >> $GITHUB_STEP_SUMMARY
            echo "## âŒ Invalid Secret Format" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**${#invalid_secrets[@]} secret(s) have invalid format:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Secret Name | Issue |" >> $GITHUB_STEP_SUMMARY
            echo "|------------|-------|" >> $GITHUB_STEP_SUMMARY
            for secret in "${invalid_secrets[@]}"; do
              echo "| \`$secret\` | Invalid format |" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“‹ How to Fix" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. Go to **Settings** â†’ **Environments** â†’ **production**" >> $GITHUB_STEP_SUMMARY
            echo "2. Update the secret(s) listed above with valid values" >> $GITHUB_STEP_SUMMARY
            echo "3. For \`CLOUDFLARE_API_TOKEN\`: Must be exactly 40 characters, alphanumeric, hyphens, or underscores only" >> $GITHUB_STEP_SUMMARY
            echo "4. For \`SUPABASE_URL\`: Must be in format \`https://xxxxx.supabase.co\`" >> $GITHUB_STEP_SUMMARY
            echo "5. Re-run this workflow in 'validate' mode to verify" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          if [ ${#missing_secrets[@]} -eq 0 ]; then
            echo "âœ… **All required secrets are configured!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "You can now run the Terraform workflow." >> $GITHUB_STEP_SUMMARY
          else
            echo "::error title=Missing Required Secrets::${#missing_secrets[@]} required secret(s) are missing" >> $GITHUB_STEP_SUMMARY
            echo "## âŒ Missing Required Secrets" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**${#missing_secrets[@]} required secret(s) need to be configured:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| # | Secret Name | Description |" >> $GITHUB_STEP_SUMMARY
            echo "|---|------------|-------------|" >> $GITHUB_STEP_SUMMARY
            counter=1
            for secret in "${missing_secrets[@]}"; do
              case "$secret" in
                CLOUDFLARE_API_TOKEN)
                  desc="Cloudflare API token"
                  ;;
                VERCEL_API_TOKEN)
                  desc="Vercel API token"
                  ;;
                SUPABASE_URL)
                  desc="Supabase project URL (format: https://xxxxx.supabase.co)"
                  ;;
                SUPABASE_ANON_KEY)
                  desc="Supabase anonymous key"
                  ;;
                SUPABASE_SERVICE_ROLE_KEY)
                  desc="Supabase service role key"
                  ;;
                SUPABASE_DATABASE_PASSWORD)
                  desc="Database password (set when creating project)"
                  ;;
                SUPABASE_ACCESS_TOKEN)
                  desc="Supabase personal access token (for database migrations)"
                  ;;
                DOMAIN_NAME)
                  desc="Your domain name"
                  ;;
                TERRAFORM_STATE_PASSWORD)
                  desc="Generate with: openssl rand -base64 32"
                  ;;
                *)
                  desc="See documentation"
                  ;;
              esac
              echo "| $counter | \`$secret\` | $desc |" >> $GITHUB_STEP_SUMMARY
              counter=$((counter + 1))
            done
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“‹ How to Fix" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. Go to **Settings** â†’ **Environments** â†’ **production** â†’ **Add secret**" >> $GITHUB_STEP_SUMMARY
            echo "2. Add each secret from the table above" >> $GITHUB_STEP_SUMMARY
            echo "3. Re-run this workflow in 'validate' mode to verify" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ’¡ Quick Copy List" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            for secret in "${missing_secrets[@]}"; do
              echo "- \`$secret\`" >> $GITHUB_STEP_SUMMARY
            done
            exit 1
          fi

  create-template:
    name: Create Secrets Template
    runs-on: ubuntu-latest
    if: github.event.inputs.setup_mode == 'create-template' || github.event.client_payload.setup_mode == 'create-template'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate Secrets Template
        run: |
          cat > SECRETS_TEMPLATE.md << 'EOF'
          # Secrets Template for GitHub Actions
          
          Copy this template and add your real values to GitHub Secrets.
          
          Go to: **Settings** â†’ **Environments** â†’ **production** â†’ **Add secret**
          
          ## Required Secrets
          
          | Secret Name | Example Value | Description |
          |------------|---------------|-------------|
          | `CLOUDFLARE_API_TOKEN` | `cf_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx` | Cloudflare API token |
          | `VERCEL_API_TOKEN` | `xxxxxxxxxxxxxxxxxxxx` | Vercel API token |
          | `SUPABASE_URL` | `https://xxxxxxxxxxxxx.supabase.co` | Supabase project URL |
          | `SUPABASE_ANON_KEY` | `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...` | Supabase anonymous key |
          | `SUPABASE_SERVICE_ROLE_KEY` | `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...` | Supabase service role key |
          | `SUPABASE_ACCESS_TOKEN` | `sbp_xxxxxxxxxxxxxxxxxxxx` | Supabase access token |
          | `SUPABASE_PROJECT_ID` | `xxxxxxxxxxxxx` | Supabase project ID |
          | `DOMAIN_NAME` | `yourdomain.com` | Your domain name |
          | `TERRAFORM_STATE_PASSWORD` | `$(openssl rand -base64 32)` | State encryption password |
          
          ## Generate State Password
          
          Run this command to generate a secure password:
          
          \`\`\`bash
          openssl rand -base64 32
          \`\`\`
          
          ## Auto-Inferred (No Need to Set)
          
          These are automatically inferred:
          - \`GITHUB_REPO\` - From repository context
          - \`VERCEL_PROJECT_NAME\` - From domain name
          - \`APP_URL\` - From project name
          - \`SITE_URL\` - From domain name
          
          See [docs/ci-cd/MINIMUM_SECRETS.md](docs/ci-cd/MINIMUM_SECRETS.md) for details.
          EOF
          
          echo "ðŸ“ Created SECRETS_TEMPLATE.md"
          
      - name: Create Issue with Setup Instructions
        uses: actions/github-script@v7
        if: github.event_name == 'repository_dispatch'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Check if welcome issue already exists to prevent duplicates
            const { data: existingIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'welcome'
            });
            
            const hasWelcomeIssue = existingIssues.some(issue => 
              issue.title.includes('Welcome') || issue.title.includes('Setup Required')
            );
            
            if (hasWelcomeIssue) {
              console.log('âš ï¸  Welcome issue already exists, skipping creation');
              return;
            }
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš€ Setup Required: Configure GitHub Secrets',
              body: `# Repository Setup Required
              
              This repository was created from a template. You need to configure secrets before running Terraform.
              
              ## Quick Setup
              
              1. Go to **Settings** â†’ **Environments** â†’ **New environment** â†’ \`production\`
              2. Add the required secrets (see template below)
              3. Run the "Setup Secrets Validation" workflow to verify
              
              ## Required Secrets
              
              See [SECRETS_TEMPLATE.md](SECRETS_TEMPLATE.md) for the complete list.
              
              **Minimum Required (9 secrets):**
              - \`CLOUDFLARE_API_TOKEN\`
              - \`VERCEL_API_TOKEN\`
              - \`SUPABASE_URL\`
              - \`SUPABASE_ANON_KEY\`
              - \`SUPABASE_SERVICE_ROLE_KEY\`
              - \`SUPABASE_ACCESS_TOKEN\`
              - \`SUPABASE_PROJECT_ID\`
              - \`DOMAIN_NAME\`
              - \`TERRAFORM_STATE_PASSWORD\` (generate with: \`openssl rand -base64 32\`)
              
              ## Next Steps
              
              - [ ] Create \`production\` environment
              - [ ] Add all required secrets
              - [ ] Run "Repository Setup" workflow â†’ "validate" mode
              - [ ] Run Terraform workflow â†’ "plan" command
              
              See [.github/MINIMUM_SECRETS.md](.github/MINIMUM_SECRETS.md) for detailed instructions.`,
              labels: ['welcome']
            })

      - name: Commit Template
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add SECRETS_TEMPLATE.md
          git commit -m "Add secrets template for repository setup" || exit 0
          git push || exit 0

  auto-setup:
    name: Auto Setup Secrets and Environment
    runs-on: ubuntu-latest
    if: github.event.inputs.setup_mode == 'auto-setup' || github.event.client_payload.setup_mode == 'auto-setup'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Production Environment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              await github.rest.repos.getEnvironment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                environment_name: 'production'
              });
              console.log('âœ… Production environment already exists');
            } catch (error) {
              if (error.status === 404) {
                await github.rest.repos.createOrUpdateEnvironment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  environment_name: 'production'
                });
                console.log('âœ… Created production environment');
              } else {
                throw error;
              }
            }

      - name: Report Setup Status
        run: |
          echo "## ðŸ“Š Setup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Production environment created successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to **Settings** â†’ **Environments** â†’ **production** â†’ **Add secret**" >> $GITHUB_STEP_SUMMARY
          echo "2. Add all required secrets (see the welcome issue for the complete list)" >> $GITHUB_STEP_SUMMARY
          echo "3. Run the **Repository Setup** workflow in 'validate' mode to verify your secrets" >> $GITHUB_STEP_SUMMARY

