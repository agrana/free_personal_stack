name: Template Variable Setup

on:
  push:
    branches:
      - main
    paths:
      - 'README.md'
  workflow_dispatch:

jobs:
  setup-from-template:
    name: Setup from Template Variables
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    # This runs when repository is created from template
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract Template Variables
        id: template-vars
        run: |
          # Check if this is a fresh template creation
          # Look for template variables in commit messages or files
          if git log --all --grep="template" --oneline | head -1; then
            echo "template_used=true" >> $GITHUB_OUTPUT
          else
            echo "template_used=false" >> $GITHUB_OUTPUT
          fi
          
          # Try to extract domain from README or other files
          if [ -f "README.md" ]; then
            DOMAIN=$(grep -oP 'yourdomain\.com|subdomain\.yourdomain\.com' README.md | head -1 || echo "")
            if [ ! -z "$DOMAIN" ] && [ "$DOMAIN" != "yourdomain.com" ]; then
              echo "domain_name=$DOMAIN" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Create Initial Configuration Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Check if setup issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'setup'
            });
            
            const setupIssueExists = issues.data.some(issue => 
              issue.title.includes('Setup Required') || 
              issue.title.includes('Configure')
            );
            
            if (!setupIssueExists) {
              const domainName = '${{ steps.template-vars.outputs.domain_name }}' || 'yourdomain.com';
              const sanitizedDomain = domainName.replace(/\./g, '-').toLowerCase();
              
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸš€ Setup Required: Configure GitHub Secrets',
                body: `# Repository Setup Required
                
This repository was created from a template. Follow these steps to configure your secrets.

## ðŸ“‹ Quick Setup Checklist

- [ ] Create \`production\` environment in Settings â†’ Environments
- [ ] Add all required secrets (see list below)
- [ ] Run "Repository Setup" workflow â†’ \`validate\` mode
- [ ] Run Terraform workflow â†’ \`plan\` command

## ðŸ” Required Secrets (8 total)

Add these to **Settings** â†’ **Environments** â†’ **production**:

### 1. Domain & Infrastructure
- \`DOMAIN_NAME\` = \`${domainName}\` (or your actual domain)

### 2. Cloudflare
- \`CLOUDFLARE_API_TOKEN\` - [Get from Cloudflare Dashboard](https://dash.cloudflare.com/profile/api-tokens)
  - Permissions needed: \`Zone:Zone:Read\`, \`Zone:DNS:Edit\`

### 3. Vercel
- \`VERCEL_API_TOKEN\` - [Get from Vercel Account](https://vercel.com/account/tokens)

### 4. Supabase (5 secrets)
- \`SUPABASE_URL\` - Project URL from Supabase Dashboard
- \`SUPABASE_ANON_KEY\` - Anonymous key from API settings
- \`SUPABASE_SERVICE_ROLE_KEY\` - Service role key (keep secret!)
- \`SUPABASE_ACCESS_TOKEN\` - [Personal access token](https://supabase.com/dashboard/account/tokens)
- \`SUPABASE_PROJECT_ID\` - Project reference ID

### 5. State Encryption
- \`TERRAFORM_STATE_PASSWORD\` - Generate with: \`openssl rand -base64 32\`

## âœ… Auto-Inferred (No Need to Set)

These are automatically configured:
- \`GITHUB_REPO\` = \`${context.repo.owner}/${context.repo.repo}\`
- \`VERCEL_PROJECT_NAME\` = \`${sanitizedDomain}\` (from domain)
- \`APP_URL\` = \`${sanitizedDomain}.vercel.app\`
- \`SITE_URL\` = \`https://${domainName}\`

## ðŸ“š Documentation

- [Minimum Secrets Guide](.github/MINIMUM_SECRETS.md) - Only 8 required secrets!
- [Terraform Setup Guide](.github/TERRAFORM_SETUP.md) - Complete setup instructions
- [Secrets Example](.github/SECRETS_EXAMPLE.md) - Detailed secret descriptions

## ðŸ”— Quick Links

- [Settings â†’ Environments](https://github.com/${context.repo.owner}/${context.repo.repo}/settings/environments)
- [Actions](https://github.com/${context.repo.owner}/${context.repo.repo}/actions)

---
**Once secrets are configured, run Terraform!** ðŸš€`,
                labels: ['setup', 'documentation']
              });
              
              console.log('âœ… Created setup issue with template variables');
            } else {
              console.log('â„¹ï¸ Setup issue already exists');
            }

      - name: Generate Secrets Template with Variables
        run: |
          DOMAIN="${DOMAIN_NAME:-yourdomain.com}"
          SANITIZED_DOMAIN=$(echo "$DOMAIN" | tr '.' '-' | tr '_' '-' | tr '[:upper:]' '[:lower:]')
          
          cat > .github/SECRETS_EXAMPLE.md << EOF
          # Secrets Configuration Guide
          
          This file shows what secrets you need to configure.
          
          ## Quick Setup
          
          1. **Create Environment:** Settings â†’ Environments â†’ New environment â†’ \`production\`
          2. **Add Secrets:** Add each secret below to the \`production\` environment
          3. **Validate:** Run "Repository Setup" workflow â†’ \`validate\` mode
          
          ## Required Secrets (8 total)
          
          ### 1. DOMAIN_NAME
          - Value: \`${DOMAIN}\`
          - Your domain name
          
          ### 2. CLOUDFLARE_API_TOKEN
          - Get from: [Cloudflare Dashboard â†’ API Tokens](https://dash.cloudflare.com/profile/api-tokens)
          - Permissions: \`Zone:Zone:Read\`, \`Zone:DNS:Edit\`
          - Example: \`cf_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\`
          
          ### 3. VERCEL_API_TOKEN
          - Get from: [Vercel Account â†’ Tokens](https://vercel.com/account/tokens)
          - Example: \`xxxxxxxxxxxxxxxxxxxx\`
          
          ### 4. SUPABASE_URL
          - Get from: Supabase Dashboard â†’ Settings â†’ API â†’ Project URL
          - Example: \`https://xxxxxxxxxxxxx.supabase.co\`
          
          ### 5. SUPABASE_ANON_KEY
          - Get from: Supabase Dashboard â†’ Settings â†’ API â†’ anon/public key
          - Example: \`eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\`
          
          ### 6. SUPABASE_SERVICE_ROLE_KEY
          - Get from: Supabase Dashboard â†’ Settings â†’ API â†’ service_role key
          - âš ï¸ Keep this secret!
          - Example: \`eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\`
          
          ### 7. SUPABASE_ACCESS_TOKEN
          - Get from: [Supabase Account â†’ Access Tokens](https://supabase.com/dashboard/account/tokens)
          - This is a personal access token (different from API keys)
          - Example: \`sbp_xxxxxxxxxxxxxxxxxxxx\`
          
          ### 8. SUPABASE_PROJECT_ID
          - Get from: Supabase Dashboard â†’ Settings â†’ General â†’ Reference ID
          - Example: \`xxxxxxxxxxxxx\`
          
          ### 9. TERRAFORM_STATE_PASSWORD
          - Generate a secure password:
            \`\`\`bash
            openssl rand -base64 32
            \`\`\`
          - Example output: \`Kx8mP2vQ9rT4nL6jH8fD1sA3bC5eG7hI9jK0lM2nP4qR6sT8uV0wX2yZ4aB6cD\`
          
          ## Auto-Inferred Values
          
          These are automatically set based on your configuration:
          
          - âœ… \`GITHUB_REPO\` = \`\${{ github.repository }}\`
          - âœ… \`VERCEL_PROJECT_NAME\` = \`${SANITIZED_DOMAIN}\`
          - âœ… \`APP_URL\` = \`${SANITIZED_DOMAIN}.vercel.app\`
          - âœ… \`SITE_URL\` = \`https://${DOMAIN}\`
          
          ## Validation
          
          After adding secrets, run the "Repository Setup" workflow with \`validate\` mode to check if all secrets are configured correctly.
          
          See [.github/MINIMUM_SECRETS.md](.github/MINIMUM_SECRETS.md) for more details.
          EOF
          
          echo "ðŸ“ Generated .github/SECRETS_EXAMPLE.md with domain: ${DOMAIN}"

      - name: Commit Setup Files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/SECRETS_EXAMPLE.md || true
          git commit -m "Add secrets configuration guide with template variables" || exit 0
          git push || exit 0

