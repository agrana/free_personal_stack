name: Repository Setup

on:
  repository_dispatch:
    types: [setup-secrets]
  workflow_dispatch:
    inputs:
      setup_mode:
        description: 'Setup mode'
        required: true
        type: choice
        options:
          - validate
          - create-template
          - auto-setup
        default: validate

jobs:
  setup:
    name: Setup Secrets Validation
    runs-on: ubuntu-latest
    if: github.event.inputs.setup_mode == 'validate' || github.event.client_payload.setup_mode == 'validate'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Required Secrets
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          VERCEL_API_TOKEN: ${{ secrets.VERCEL_API_TOKEN }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
          DOMAIN_NAME: ${{ secrets.DOMAIN_NAME }}
          TERRAFORM_STATE_PASSWORD: ${{ secrets.TERRAFORM_STATE_PASSWORD }}
        run: |
          echo "## ðŸ” Validating Secrets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          missing_secrets=()
          
          if [ -z "$CLOUDFLARE_API_TOKEN" ]; then missing_secrets+=("CLOUDFLARE_API_TOKEN"); fi
          if [ -z "$VERCEL_API_TOKEN" ]; then missing_secrets+=("VERCEL_API_TOKEN"); fi
          if [ -z "$SUPABASE_URL" ]; then missing_secrets+=("SUPABASE_URL"); fi
          if [ -z "$SUPABASE_ANON_KEY" ]; then missing_secrets+=("SUPABASE_ANON_KEY"); fi
          if [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then missing_secrets+=("SUPABASE_SERVICE_ROLE_KEY"); fi
          if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then missing_secrets+=("SUPABASE_ACCESS_TOKEN"); fi
          if [ -z "$SUPABASE_PROJECT_ID" ]; then missing_secrets+=("SUPABASE_PROJECT_ID"); fi
          if [ -z "$DOMAIN_NAME" ]; then missing_secrets+=("DOMAIN_NAME"); fi
          if [ -z "$TERRAFORM_STATE_PASSWORD" ]; then missing_secrets+=("TERRAFORM_STATE_PASSWORD"); fi
          
          if [ ${#missing_secrets[@]} -eq 0 ]; then
            echo "âœ… All required secrets are configured!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "You can now run the Terraform workflow." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Missing required secrets:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            for secret in "${missing_secrets[@]}"; do
              echo "- \`$secret\`" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ‘‰ See [.github/MINIMUM_SECRETS.md](.github/MINIMUM_SECRETS.md) for setup instructions." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  create-template:
    name: Create Secrets Template
    runs-on: ubuntu-latest
    if: github.event.inputs.setup_mode == 'create-template' || github.event.client_payload.setup_mode == 'create-template'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate Secrets Template
        run: |
          cat > SECRETS_TEMPLATE.md << 'EOF'
          # Secrets Template for GitHub Actions
          
          Copy this template and add your real values to GitHub Secrets.
          
          Go to: **Settings** â†’ **Environments** â†’ **production** â†’ **Add secret**
          
          ## Required Secrets
          
          | Secret Name | Example Value | Description |
          |------------|---------------|-------------|
          | `CLOUDFLARE_API_TOKEN` | `cf_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx` | Cloudflare API token |
          | `VERCEL_API_TOKEN` | `xxxxxxxxxxxxxxxxxxxx` | Vercel API token |
          | `SUPABASE_URL` | `https://xxxxxxxxxxxxx.supabase.co` | Supabase project URL |
          | `SUPABASE_ANON_KEY` | `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...` | Supabase anonymous key |
          | `SUPABASE_SERVICE_ROLE_KEY` | `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...` | Supabase service role key |
          | `SUPABASE_ACCESS_TOKEN` | `sbp_xxxxxxxxxxxxxxxxxxxx` | Supabase access token |
          | `SUPABASE_PROJECT_ID` | `xxxxxxxxxxxxx` | Supabase project ID |
          | `DOMAIN_NAME` | `yourdomain.com` | Your domain name |
          | `TERRAFORM_STATE_PASSWORD` | `$(openssl rand -base64 32)` | State encryption password |
          
          ## Generate State Password
          
          Run this command to generate a secure password:
          
          \`\`\`bash
          openssl rand -base64 32
          \`\`\`
          
          ## Auto-Inferred (No Need to Set)
          
          These are automatically inferred:
          - \`GITHUB_REPO\` - From repository context
          - \`VERCEL_PROJECT_NAME\` - From domain name
          - \`APP_URL\` - From project name
          - \`SITE_URL\` - From domain name
          
          See [.github/MINIMUM_SECRETS.md](.github/MINIMUM_SECRETS.md) for details.
          EOF
          
          echo "ðŸ“ Created SECRETS_TEMPLATE.md"
          
      - name: Create Issue with Setup Instructions
        uses: actions/github-script@v7
        if: github.event_name == 'repository_dispatch'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš€ Setup Required: Configure GitHub Secrets',
              body: `# Repository Setup Required
              
              This repository was created from a template. You need to configure secrets before running Terraform.
              
              ## Quick Setup
              
              1. Go to **Settings** â†’ **Environments** â†’ **New environment** â†’ \`production\`
              2. Add the required secrets (see template below)
              3. Run the "Setup Secrets Validation" workflow to verify
              
              ## Required Secrets
              
              See [SECRETS_TEMPLATE.md](SECRETS_TEMPLATE.md) for the complete list.
              
              **Minimum Required (8 secrets):**
              - \`CLOUDFLARE_API_TOKEN\`
              - \`VERCEL_API_TOKEN\`
              - \`SUPABASE_URL\`
              - \`SUPABASE_ANON_KEY\`
              - \`SUPABASE_SERVICE_ROLE_KEY\`
              - \`SUPABASE_ACCESS_TOKEN\`
              - \`SUPABASE_PROJECT_ID\`
              - \`DOMAIN_NAME\`
              - \`TERRAFORM_STATE_PASSWORD\` (generate with: \`openssl rand -base64 32\`)
              
              ## Next Steps
              
              - [ ] Create \`production\` environment
              - [ ] Add all required secrets
              - [ ] Run "Repository Setup" workflow â†’ "validate" mode
              - [ ] Run Terraform workflow â†’ "plan" command
              
              See [.github/MINIMUM_SECRETS.md](.github/MINIMUM_SECRETS.md) for detailed instructions.`
            })

      - name: Commit Template
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add SECRETS_TEMPLATE.md
          git commit -m "Add secrets template for repository setup" || exit 0
          git push || exit 0

  auto-setup:
    name: Auto Setup Secrets and Environment
    runs-on: ubuntu-latest
    if: github.event.inputs.setup_mode == 'auto-setup' || github.event.client_payload.setup_mode == 'auto-setup'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install GitHub CLI
        uses: actions/setup-gh@v3

      - name: Create Production Environment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              await github.rest.repos.getEnvironment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                environment_name: 'production'
              });
              console.log('âœ… Production environment already exists');
            } catch (error) {
              if (error.status === 404) {
                await github.rest.repos.createOrUpdateEnvironment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  environment_name: 'production'
                });
                console.log('âœ… Created production environment');
              } else {
                throw error;
              }
            }

      - name: Check Existing Secrets
        id: check-secrets
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          VERCEL_API_TOKEN: ${{ secrets.VERCEL_API_TOKEN }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
          DOMAIN_NAME: ${{ secrets.DOMAIN_NAME }}
          TERRAFORM_STATE_PASSWORD: ${{ secrets.TERRAFORM_STATE_PASSWORD }}
        run: |
          missing_secrets=()
          existing_secrets=()
          
          if [ -z "$CLOUDFLARE_API_TOKEN" ]; then missing_secrets+=("CLOUDFLARE_API_TOKEN"); else existing_secrets+=("CLOUDFLARE_API_TOKEN"); fi
          if [ -z "$VERCEL_API_TOKEN" ]; then missing_secrets+=("VERCEL_API_TOKEN"); else existing_secrets+=("VERCEL_API_TOKEN"); fi
          if [ -z "$SUPABASE_URL" ]; then missing_secrets+=("SUPABASE_URL"); else existing_secrets+=("SUPABASE_URL"); fi
          if [ -z "$SUPABASE_ANON_KEY" ]; then missing_secrets+=("SUPABASE_ANON_KEY"); else existing_secrets+=("SUPABASE_ANON_KEY"); fi
          if [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then missing_secrets+=("SUPABASE_SERVICE_ROLE_KEY"); else existing_secrets+=("SUPABASE_SERVICE_ROLE_KEY"); fi
          if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then missing_secrets+=("SUPABASE_ACCESS_TOKEN"); else existing_secrets+=("SUPABASE_ACCESS_TOKEN"); fi
          if [ -z "$SUPABASE_PROJECT_ID" ]; then missing_secrets+=("SUPABASE_PROJECT_ID"); else existing_secrets+=("SUPABASE_PROJECT_ID"); fi
          if [ -z "$DOMAIN_NAME" ]; then missing_secrets+=("DOMAIN_NAME"); else existing_secrets+=("DOMAIN_NAME"); fi
          if [ -z "$TERRAFORM_STATE_PASSWORD" ]; then missing_secrets+=("TERRAFORM_STATE_PASSWORD"); else existing_secrets+=("TERRAFORM_STATE_PASSWORD"); fi
          
          if [ ${#existing_secrets[@]} -gt 0 ]; then
            echo "existing=$(IFS=','; echo "${existing_secrets[*]}")" >> $GITHUB_OUTPUT
          fi
          if [ ${#missing_secrets[@]} -gt 0 ]; then
            echo "missing=$(IFS=','; echo "${missing_secrets[*]}")" >> $GITHUB_OUTPUT
          fi

      - name: Generate TERRAFORM_STATE_PASSWORD
        id: generate-password
        if: contains(steps.check-secrets.outputs.missing, 'TERRAFORM_STATE_PASSWORD')
        run: |
          PASSWORD=$(openssl rand -base64 32)
          echo "password=$PASSWORD" >> $GITHUB_OUTPUT
          echo "âœ… Generated TERRAFORM_STATE_PASSWORD"

      - name: Create Auto-Generated Secrets via GitHub CLI
        id: set-password
        if: steps.generate-password.outputs.password != ''
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          echo "## ðŸ” Auto-Setting Secrets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -z "$GH_PAT" ]; then
            echo "âš ï¸  GH_PAT not provided, skipping auto-set of TERRAFORM_STATE_PASSWORD" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ’¡ To enable auto-setting secrets, add a \`GH_PAT\` secret with admin permissions." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          gh auth login --with-token <<< "$GH_PAT"
          
          if [ -n "${{ steps.generate-password.outputs.password }}" ]; then
            echo "${{ steps.generate-password.outputs.password }}" | gh secret set TERRAFORM_STATE_PASSWORD --env production --repo "${{ github.repository }}"
            echo "âœ… Created secret: \`TERRAFORM_STATE_PASSWORD\` (auto-generated)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ To auto-create other secrets, provide them as environment variables or add them manually in GitHub Settings." >> $GITHUB_STEP_SUMMARY

      - name: Report Setup Status
        run: |
          echo "## ðŸ“Š Setup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          EXISTING="${{ steps.check-secrets.outputs.existing }}"
          MISSING="${{ steps.check-secrets.outputs.missing }}"
          PASSWORD_GENERATED="${{ steps.generate-password.outputs.password != '' }}"
          SET_PASSWORD_OUTCOME="${{ steps.set-password.outcome }}"
          GH_PAT_PROVIDED="false"
          if [ "$SET_PASSWORD_OUTCOME" = "success" ]; then
            GH_PAT_PROVIDED="true"
          fi
          
          if [ -n "$EXISTING" ]; then
            echo "### âœ… Existing Secrets" >> $GITHUB_STEP_SUMMARY
            IFS=',' read -ra EXISTING_ARRAY <<< "$EXISTING"
            for secret in "${EXISTING_ARRAY[@]}"; do
              echo "- \`$secret\`" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -n "$MISSING" ]; then
            echo "### âš ï¸  Missing Secrets" >> $GITHUB_STEP_SUMMARY
            IFS=',' read -ra MISSING_ARRAY <<< "$MISSING"
            for secret in "${MISSING_ARRAY[@]}"; do
              if [ "$secret" == "TERRAFORM_STATE_PASSWORD" ] && [ "$PASSWORD_GENERATED" == "true" ] && [ "$GH_PAT_PROVIDED" == "true" ]; then
                echo "- \`$secret\` âœ… (auto-generated and set)" >> $GITHUB_STEP_SUMMARY
              elif [ "$secret" == "TERRAFORM_STATE_PASSWORD" ] && [ "$PASSWORD_GENERATED" == "true" ]; then
                echo "- \`$secret\` âš ï¸  (generated but not set - add \`GH_PAT\` secret to auto-set)" >> $GITHUB_STEP_SUMMARY
                echo "  Generated value: \`${{ steps.generate-password.outputs.password }}\`" >> $GITHUB_STEP_SUMMARY
              else
                echo "- \`$secret\` (needs manual setup)" >> $GITHUB_STEP_SUMMARY
              fi
            done
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -z "$MISSING" ]; then
            echo "âœ… All secrets are configured! You can now run the Terraform workflow." >> $GITHUB_STEP_SUMMARY
          elif [ "$MISSING" == "TERRAFORM_STATE_PASSWORD" ] && [ "$PASSWORD_GENERATED" == "true" ] && [ "$GH_PAT_PROVIDED" == "true" ]; then
            echo "âœ… All secrets are configured! You can now run the Terraform workflow." >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  Some secrets still need to be configured." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**To set secrets:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Go to **Settings** â†’ **Environments** â†’ **production** â†’ **Add secret**" >> $GITHUB_STEP_SUMMARY
            if [ "$GH_PAT_PROVIDED" != "true" ]; then
              echo "2. Or add a \`GH_PAT\` secret (Personal Access Token with \`admin:repo\` scope) to enable auto-creation" >> $GITHUB_STEP_SUMMARY
            fi
          fi

