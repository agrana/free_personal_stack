name: Repository Setup Trigger

on:
  push:
    branches:
      - main
      - master
  repository_dispatch:
    types: [repository-created]
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  actions: write

jobs:
  trigger-setup:
    name: Trigger Repository Setup
    runs-on: ubuntu-latest
    # Only run on first push (initial commit) or manual trigger
    # Check if this is the initial commit by checking if before SHA is all zeros
    if: |
      github.event_name == 'workflow_dispatch' || 
      github.event_name == 'repository_dispatch' || 
      github.event.before == '0000000000000000000000000000000000000000'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if this is initial commit
        id: check-initial
        run: |
          COMMIT_COUNT=$(git rev-list --count HEAD 2>/dev/null || echo "1")
          if [ "$COMMIT_COUNT" -le "1" ]; then
            echo "is_initial=true" >> $GITHUB_OUTPUT
            echo "‚úÖ This appears to be the initial commit (commit count: $COMMIT_COUNT)"
          else
            echo "is_initial=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Not the initial commit (commit count: $COMMIT_COUNT), skipping setup"
          fi

      - name: Trigger Setup Workflow
        if: steps.check-initial.outputs.is_initial == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'setup.yml',
              ref: context.ref,
              inputs: {
                setup_mode: 'auto-setup'
              }
            });

      - name: Create Initial Issue
        if: steps.check-initial.outputs.is_initial == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üöÄ Welcome! Repository Setup Required',
              body: '# Welcome to Your New Repository!\n\n' +
                'This repository was created from a template. Follow these steps to get started:\n\n' +
                '## Quick Start\n\n' +
                '1. **Configure GitHub Secrets**\n' +
                '   - Go to **Settings** ‚Üí **Environments** ‚Üí **New environment** ‚Üí `production`\n' +
                '   - Add all required secrets (see below)\n\n' +
                '2. **Run Setup Validation**\n' +
                '   - Go to **Actions** ‚Üí **Repository Setup** ‚Üí **Run workflow**\n' +
                '   - Select `validate` mode to check your secrets\n\n' +
                '3. **Deploy Infrastructure**\n' +
                '   - Once secrets are validated, run **Terraform Infrastructure** workflow\n' +
                '   - Start with `plan` command to preview changes\n\n' +
                '## Required Secrets\n\n' +
                'You need to configure these secrets in the `production` environment:\n\n' +
                '- `CLOUDFLARE_API_TOKEN` - Your Cloudflare API token\n' +
                '- `VERCEL_API_TOKEN` - Your Vercel API token\n' +
                '- `SUPABASE_URL` - Your Supabase project URL\n' +
                '- `SUPABASE_ANON_KEY` - Supabase anonymous key\n' +
                '- `SUPABASE_SERVICE_ROLE_KEY` - Supabase service role key\n' +
                '- `SUPABASE_ACCESS_TOKEN` - Supabase access token\n' +
                '- `SUPABASE_PROJECT_ID` - Supabase project ID\n' +
                '- `DOMAIN_NAME` - Your domain name\n' +
                '- `TERRAFORM_STATE_PASSWORD` - Generate with: `openssl rand -base64 32`\n\n' +
                '## Next Steps\n\n' +
                '- [ ] Create `production` environment in GitHub\n' +
                '- [ ] Add all required secrets\n' +
                '- [ ] Run "Repository Setup" workflow ‚Üí "validate" mode\n' +
                '- [ ] Run "Terraform Infrastructure" workflow ‚Üí "plan" command\n' +
                '- [ ] Review the plan and run "apply" when ready\n\n' +
                'For detailed instructions, see [.github/TERRAFORM_SETUP.md](.github/TERRAFORM_SETUP.md)'
            });

