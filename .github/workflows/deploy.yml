name: Deploy to Supabase

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  SUPABASE_VERSION: '2.65.5'

jobs:
  migrate:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: ${{ env.SUPABASE_VERSION }}

      - name: Verify migrations directory exists
        run: |
          if [ ! -d "supabase/migrations" ]; then
            echo "‚ùå Error: supabase/migrations directory not found"
            exit 1
          fi
          MIGRATION_COUNT=$(find supabase/migrations -name "*.sql" | wc -l)
          echo "‚úÖ Found $MIGRATION_COUNT migration file(s)"
          if [ "$MIGRATION_COUNT" -eq 0 ]; then
            echo "‚ö†Ô∏è  Warning: No migration files found in supabase/migrations/"
          fi

      - name: Link Supabase project
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
          SUPABASE_DATABASE_PASSWORD: ${{ secrets.SUPABASE_DATABASE_PASSWORD }}
        run: |
          echo "üîó Linking to Supabase project: $SUPABASE_PROJECT_ID"
          echo "üìù Verifying secrets are set..."
          if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then
            echo "‚ùå SUPABASE_ACCESS_TOKEN is not set"
            exit 1
          fi
          if [ -z "$SUPABASE_PROJECT_ID" ]; then
            echo "‚ùå SUPABASE_PROJECT_ID is not set"
            exit 1
          fi
          if [ -z "$SUPABASE_DATABASE_PASSWORD" ]; then
            echo "‚ùå SUPABASE_DATABASE_PASSWORD is not set"
            exit 1
          fi
          echo "‚úÖ All secrets are set"
          echo "üîê Password length: ${#SUPABASE_DATABASE_PASSWORD} characters"
          
          # Retry linking in case of temporary connection issues
          for i in 1 2 3; do
            echo "üîÑ Link attempt $i of 3..."
            if npx supabase link --project-ref "$SUPABASE_PROJECT_ID" --password "$SUPABASE_DATABASE_PASSWORD" 2>&1; then
              echo "‚úÖ Successfully linked to Supabase project"
              # Verify link by checking if .temp directory was created
              if [ -f "supabase/.temp/project-ref" ]; then
                echo "‚úÖ Link verification successful (project-ref file exists)"
                exit 0
              else
                echo "‚ö†Ô∏è  Link completed but project-ref file not found, continuing anyway..."
                exit 0
              fi
            else
              LINK_EXIT_CODE=$?
              echo "‚ùå Link attempt $i failed with exit code $LINK_EXIT_CODE"
              if [ $i -lt 3 ]; then
                echo "‚è≥ Retrying in 5 seconds..."
                sleep 5
              fi
            fi
          done
          echo "‚ùå Failed to link after 3 attempts"
          echo "üí° Troubleshooting tips:"
          echo "   - Verify SUPABASE_DATABASE_PASSWORD is correct in GitHub Secrets"
          echo "   - Check that the password matches the one in Supabase Dashboard ‚Üí Settings ‚Üí Database"
          echo "   - Ensure SUPABASE_ACCESS_TOKEN is a personal access token (not service role key)"
          echo "   - Verify SUPABASE_PROJECT_ID matches your project's Reference ID"
          exit 1
      
      - name: Install expect for non-interactive password input
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y expect

      - name: Run database migrations
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DATABASE_PASSWORD: ${{ secrets.SUPABASE_DATABASE_PASSWORD }}
          PGPASSWORD: ${{ secrets.SUPABASE_DATABASE_PASSWORD }}
        run: |
          echo "üöÄ Pushing database migrations..."
          # Use expect to provide password non-interactively when prompted
          # PGPASSWORD might also work for some PostgreSQL tools
          expect <<'EXPECT_SCRIPT'
            set timeout 120
            spawn npx supabase db push
            expect {
              "Enter your database password:" {
                send "$env(SUPABASE_DATABASE_PASSWORD)\r"
                exp_continue
              }
              "Forgot your password?" {
                send "$env(SUPABASE_DATABASE_PASSWORD)\r"
                exp_continue
              }
              "Connecting to remote database..." {
                exp_continue
              }
              "Applying migration" {
                exp_continue
              }
              "Migration applied successfully" {
                exp_continue
              }
              "Finished" {
                exp_continue
              }
              "‚úÖ" {
                exp_continue
              }
              "error" {
                puts "Error detected in output"
                exp_continue
              }
              eof {
                catch wait result
                set exit_code [lindex $result 3]
                exit $exit_code
              }
              timeout {
                puts "Timeout waiting for command (120s)"
                exit 1
              }
            }
          EXPECT_SCRIPT
          MIGRATION_EXIT=$?
          if [ $MIGRATION_EXIT -eq 0 ]; then
            echo "‚úÖ Migrations applied successfully"
          else
            echo "‚ùå Migration push failed with exit code $MIGRATION_EXIT"
            exit 1
          fi

      - name: Verify migrations applied
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DATABASE_PASSWORD: ${{ secrets.SUPABASE_DATABASE_PASSWORD }}
          PGPASSWORD: ${{ secrets.SUPABASE_DATABASE_PASSWORD }}
        run: |
          echo "üîç Verifying migrations..."
          expect <<'EXPECT_SCRIPT' || echo "‚ö†Ô∏è  Could not list migrations (this is not critical)"
            set timeout 30
            spawn npx supabase migration list
            expect {
              "Enter your database password:" {
                send "$env(SUPABASE_DATABASE_PASSWORD)\r"
                exp_continue
              }
              "Forgot your password?" {
                send "$env(SUPABASE_DATABASE_PASSWORD)\r"
                exp_continue
              }
              eof {
                catch wait result
                set exit_code [lindex $result 3]
                exit $exit_code
              }
              timeout {
                puts "Timeout"
                exit 1
              }
            }
          EXPECT_SCRIPT
