name: Deploy to Supabase

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  NODE_VERSION: '24'
  SUPABASE_VERSION: '2.65.5'

jobs:
  migrate:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: ${{ env.SUPABASE_VERSION }}

      - name: Validate required secrets
        id: validate-secrets
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DATABASE_PASSWORD: ${{ secrets.SUPABASE_DATABASE_PASSWORD }}
        run: |
          echo "## üîç Validating Required Secrets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          missing_secrets=()
          
          # Extract project ID from SUPABASE_URL
          if [ -n "$SUPABASE_URL" ]; then
            EXTRACTED_PROJECT_ID=$(echo "$SUPABASE_URL" | sed -E 's|https?://([^.]+)\.supabase\.co.*|\1|')
            if [ -n "$EXTRACTED_PROJECT_ID" ] && [ "$EXTRACTED_PROJECT_ID" != "$SUPABASE_URL" ]; then
              echo "project_id=$EXTRACTED_PROJECT_ID" >> $GITHUB_OUTPUT
              echo "‚úÖ Extracted project ID from SUPABASE_URL: \`$EXTRACTED_PROJECT_ID\`" >> $GITHUB_STEP_SUMMARY
            else
              missing_secrets+=("SUPABASE_URL (invalid format - must be https://xxxxx.supabase.co)")
            fi
          else
            missing_secrets+=("SUPABASE_URL")
          fi
          
          if [ -z "$SUPABASE_DATABASE_PASSWORD" ]; then missing_secrets+=("SUPABASE_DATABASE_PASSWORD"); fi
          
          if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then missing_secrets+=("SUPABASE_ACCESS_TOKEN"); fi
          
          if [ ${#missing_secrets[@]} -gt 0 ]; then
            echo "::error title=Missing Required Secrets::${#missing_secrets[@]} required secret(s) are missing" >> $GITHUB_STEP_SUMMARY
            echo "‚ùå Missing required secrets (${#missing_secrets[@]}):" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            for secret in "${missing_secrets[@]}"; do
              echo "- \`$secret\`" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### How to Fix:" >> $GITHUB_STEP_SUMMARY
            echo "1. Go to **Settings** ‚Üí **Environments** ‚Üí **production**" >> $GITHUB_STEP_SUMMARY
            echo "2. Add the missing secrets listed above" >> $GITHUB_STEP_SUMMARY
            echo "3. Check the welcome issue for detailed instructions" >> $GITHUB_STEP_SUMMARY
            echo "4. Re-run this workflow after adding secrets" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "‚úÖ All required secrets are configured!" >> $GITHUB_STEP_SUMMARY
          echo "secrets_valid=true" >> $GITHUB_OUTPUT

      - name: Verify migrations directory exists
        run: |
          if [ ! -d "supabase/migrations" ]; then
            echo "‚ùå Error: supabase/migrations directory not found"
            exit 1
          fi
          MIGRATION_COUNT=$(find supabase/migrations -name "*.sql" | wc -l)
          echo "‚úÖ Found $MIGRATION_COUNT migration file(s)"
          if [ "$MIGRATION_COUNT" -eq 0 ]; then
            echo "‚ö†Ô∏è  Warning: No migration files found in supabase/migrations/"
          fi

      - name: Link Supabase project
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ steps.validate-secrets.outputs.project_id }}
          SUPABASE_DATABASE_PASSWORD: ${{ secrets.SUPABASE_DATABASE_PASSWORD }}
        run: |
          echo "üîó Linking to Supabase project: $SUPABASE_PROJECT_ID"
          echo "üìù Verifying secrets are set..."
          if [ -z "$SUPABASE_PROJECT_ID" ]; then
            echo "‚ùå SUPABASE_PROJECT_ID could not be extracted from SUPABASE_URL"
            exit 1
          fi
          if [ -z "$SUPABASE_DATABASE_PASSWORD" ]; then
            echo "‚ùå SUPABASE_DATABASE_PASSWORD is not set"
            exit 1
          fi
          if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then
            echo "‚ùå SUPABASE_ACCESS_TOKEN is not set"
            exit 1
          fi
          echo "‚úÖ All secrets are set"
          echo "üîê Password length: ${#SUPABASE_DATABASE_PASSWORD} characters"
          
          # Retry linking in case of temporary connection issues
          for i in 1 2 3; do
            echo "üîÑ Link attempt $i of 3..."
            if npx supabase link --project-ref "$SUPABASE_PROJECT_ID" --password "$SUPABASE_DATABASE_PASSWORD" 2>&1; then
              echo "‚úÖ Successfully linked to Supabase project"
              # Verify link by checking if .temp directory was created
              if [ -f "supabase/.temp/project-ref" ]; then
                echo "‚úÖ Link verification successful (project-ref file exists)"
                exit 0
              else
                echo "‚ö†Ô∏è  Link completed but project-ref file not found, continuing anyway..."
                exit 0
              fi
            else
              LINK_EXIT_CODE=$?
              echo "‚ùå Link attempt $i failed with exit code $LINK_EXIT_CODE"
              if [ $i -lt 3 ]; then
                echo "‚è≥ Retrying in 5 seconds..."
                sleep 5
              fi
            fi
          done
          echo "‚ùå Failed to link after 3 attempts"
          echo "üí° Troubleshooting tips:"
          echo "   - Verify SUPABASE_DATABASE_PASSWORD is correct in GitHub Secrets"
          echo "   - Check that the password matches the one in Supabase Dashboard ‚Üí Settings ‚Üí Database"
          echo "   - Verify SUPABASE_URL is in format: https://xxxxx.supabase.co"
          echo "   - Ensure SUPABASE_ACCESS_TOKEN is a personal access token (not service role key)"
          exit 1
      
      - name: Run database migrations
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DATABASE_PASSWORD }}
        run: |
          echo "üöÄ Pushing database migrations..."
          # SUPABASE_DB_PASSWORD env var is automatically used by Supabase CLI
          # This avoids password prompts in CI/CD environments
          if npx supabase db push; then
            echo "‚úÖ Migrations applied successfully"
          else
            echo "‚ùå Migration push failed"
            echo "Checking migration status..."
            npx supabase migration list || true
            exit 1
          fi

      - name: Verify migrations applied
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DATABASE_PASSWORD }}
        run: |
          echo "üîç Verifying migrations..."
          npx supabase migration list || echo "‚ö†Ô∏è  Could not list migrations (this is not critical)"
